<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë¶€ë™ì‚° ê³„ì•½ì„œ ìœ„í—˜ ë¶„ì„ê¸°</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      body {
        font-family: "Malgun Gothic", sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f4f4f9;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #2c3e50;
        text-align: center;
      }

      /* ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
      .login-box {
        text-align: center;
        padding: 20px;
      }
      .login-box input {
        padding: 10px;
        margin: 5px;
        width: 200px;
        border-radius: 5px;
        border: 1px solid #ddd;
      }
      .btn-primary {
        background-color: #3498db;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
      }
      .btn-secondary {
        background-color: #95a5a6;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
      }
      .btn-primary:hover {
        background-color: #2980b9;
      }

      /* ë©”ì¸ ì•± ìŠ¤íƒ€ì¼ (ì²˜ìŒì—” ìˆ¨ê¹€) */
      #app-page {
        display: none;
      }

      .upload-box {
        border: 2px dashed #3498db;
        padding: 40px;
        text-align: center;
        margin-bottom: 20px;
        border-radius: 10px;
      }
      .btn-group {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .btn-group button {
        flex: 1;
        padding: 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        color: white;
        font-weight: bold;
      }
      .btn-analyze {
        background-color: #3498db;
      }
      .btn-txt {
        background-color: #27ae60;
        display: none;
      }
      .btn-pdf {
        background-color: #e74c3c;
        display: none;
      }

      #result-area {
        margin-top: 20px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #fff;
        display: none;
        line-height: 1.6;
      }
      .loading {
        color: #e67e22;
        font-weight: bold;
        display: none;
        text-align: center;
        margin-top: 20px;
        font-size: 18px;
      }

      /* ì´ë ¥ í…Œì´ë¸” */
      .history-section {
        margin-top: 40px;
        border-top: 2px solid #eee;
        padding-top: 30px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
      }
      th,
      td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }
      th {
        background-color: #f8f9fa;
        font-weight: bold;
      }
      #history-list tr {
        cursor: pointer;
        transition: background-color 0.2s;
      }
      #history-list tr:hover {
        background-color: #e3f2fd;
      }

      .badge {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
        color: white;
      }
      .badge-safe {
        background-color: #27ae60;
      }
      .badge-warning {
        background-color: #f39c12;
      }
      .badge-danger {
        background-color: #e74c3c;
      }
      .badge-unknown {
        background-color: #95a5a6;
      }

      /* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ */
      .logout-area {
        text-align: right;
        margin-bottom: 10px;
      }
      .btn-logout {
        background: none;
        border: none;
        color: #7f8c8d;
        cursor: pointer;
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ  ë¶€ë™ì‚° ê³„ì•½ì„œ ìœ„í—˜ ë¶„ì„ê¸°</h1>

      <div id="login-page" class="login-box">
        <h2>ë¡œê·¸ì¸</h2>
        <input type="text" id="username" placeholder="ì•„ì´ë””" /><br />
        <input
          type="password"
          id="password"
          placeholder="ë¹„ë°€ë²ˆí˜¸"
        /><br /><br />
        <button class="btn-primary" onclick="login()">ë¡œê·¸ì¸</button>
        <button class="btn-secondary" onclick="signup()">íšŒì›ê°€ì…</button>
      </div>

      <div id="app-page">
        <div class="logout-area">
          <span
            id="user-display"
            style="font-weight: bold; color: #3498db"
          ></span
          >ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!
          <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <div
          class="selection-box"
          style="margin-bottom: 20px; text-align: center"
        >
          <label for="contract-type" style="font-weight: bold; font-size: 1.1em"
            >ğŸ“‚ ê³„ì•½ì„œ ì¢…ë¥˜ ì„ íƒ:</label
          >
          <select
            id="contract-type"
            style="padding: 10px; border-radius: 5px; margin-left: 10px"
          >
            <option value="real_estate">ğŸ  ë¶€ë™ì‚° ì„ëŒ€ì°¨ ê³„ì•½ì„œ</option>
            <option value="labor">ğŸ’¼ ê·¼ë¡œ ê³„ì•½ì„œ (ì•Œë°”/ì§ì¥ì¸)</option>
          </select>
        </div>

        <div class="upload-box">
          <input
            type="file"
            id="fileInput"
            multiple
            accept=".pdf, .png, .jpg, .jpeg"
            style="padding: 10px; width: 80%"
          />
          <p style="margin-top: 10px; color: #666; font-size: 0.9em">
            * Ctrl í‚¤ë¥¼ ëˆ„ë¥´ê³  í´ë¦­í•˜ë©´ ì—¬ëŸ¬ íŒŒì¼(ê³„ì•½ì„œ, ë“±ê¸°ë¶€ë“±ë³¸ ë“±)ì„
            ë™ì‹œì— ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>

        <div class="btn-group">
          <button type="button" class="btn-analyze" onclick="analyzeContract()">
            ğŸ” ë¶„ì„ ì‹œì‘
          </button>
          <button id="downloadTxtBtn" class="btn-txt" onclick="downloadTxt()">
            ğŸ’¾ TXT ì €ì¥
          </button>
          <button id="downloadPdfBtn" class="btn-pdf" onclick="downloadPdf()">
            ğŸ“• PDF ì €ì¥
          </button>
        </div>

        <div id="loading" class="loading">
          AIê°€ ê³„ì•½ì„œë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... â³
        </div>
        <div id="result-area"></div>

        <div class="history-section">
          <h2>ğŸ“œ ë‚˜ì˜ ë¶„ì„ ì´ë ¥</h2>
          <table>
            <thead>
              <tr>
                <th style="width: 20%">ë‚ ì§œ</th>
                <th style="width: 50%">íŒŒì¼ëª…</th>
                <th style="width: 30%">ìœ„í—˜ ë“±ê¸‰</th>
              </tr>
            </thead>
            <tbody id="history-list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      let currentAnalysisText = "";

      // [ê¸°ëŠ¥ 1] íšŒì›ê°€ì…
      async function signup() {
        const id = document.getElementById("username").value;
        const pw = document.getElementById("password").value;
        if (!id || !pw) return alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        const formData = new FormData();
        formData.append("username", id);
        formData.append("password", pw);

        try {
          const res = await fetch("http://127.0.0.1:8000/signup", {
            method: "POST",
            body: formData,
          });
          if (res.ok) alert("ê°€ì… ì„±ê³µ! ì´ì œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
          else alert("ê°€ì… ì‹¤íŒ¨: ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        } catch (e) {
          alert("ì„œë²„ ì˜¤ë¥˜");
        }
      }

      // [ê¸°ëŠ¥ 2] ë¡œê·¸ì¸
      async function login() {
        const id = document.getElementById("username").value;
        const pw = document.getElementById("password").value;

        const formData = new FormData();
        formData.append("username", id);
        formData.append("password", pw);

        try {
          const res = await fetch("http://127.0.0.1:8000/token", {
            method: "POST",
            body: formData,
          });
          if (res.ok) {
            const data = await res.json();
            localStorage.setItem("access_token", data.access_token);
            localStorage.setItem("username", id);
            showApp();
          } else {
            alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: ì•„ì´ë””/ë¹„ë²ˆì„ í™•ì¸í•˜ì„¸ìš”.");
          }
        } catch (e) {
          alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
        }
      }

      // [ê¸°ëŠ¥ 3] ë¡œê·¸ì•„ì›ƒ
      function logout() {
        localStorage.removeItem("access_token");
        location.reload(); // ìƒˆë¡œê³ ì¹¨í•´ì„œ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
      }

      // í™”ë©´ ì „í™˜ í•¨ìˆ˜
      function showApp() {
        document.getElementById("login-page").style.display = "none";
        document.getElementById("app-page").style.display = "block";
        document.getElementById("user-display").innerText =
          localStorage.getItem("username");
        loadHistory(); // ë¡œê·¸ì¸ í–ˆìœ¼ë‹ˆ ì´ë ¥ ë¶ˆëŸ¬ì˜¤ê¸°
      }

      // [ê¸°ëŠ¥ 4] ë¶„ì„ ìš”ì²­ (í† í° ì²¨ë¶€!)
      async function analyzeContract() {
        const fileInput = document.getElementById("fileInput");
        const token = localStorage.getItem("access_token"); // í† í° êº¼ë‚´ê¸°
        const typeSelect = document.getElementById("contract-type");

        if (!typeSelect) {
          alert("HTMLì— 'contract-type' ì•„ì´ë””ë¥¼ ê°€ì§„ select íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤!");
          return;
        }
        const contractType = typeSelect.value;

        if (!token) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          return logout();
        }
        if (fileInput.files.length === 0) return alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

        // UI ì´ˆê¸°í™”
        document.getElementById("result-area").style.display = "none";
        document.getElementById("loading").style.display = "block";

        const formData = new FormData();
        for (let i = 0; i < fileInput.files.length; i++) {
          formData.append("files", fileInput.files[i]);
        }

        formData.append("type", contractType);

        try {
          const res = await fetch("http://127.0.0.1:8000/analyze-contract", {
            method: "POST",
            headers: {
              Authorization: "Bearer " + token, // â˜… ì¶œì…ì¦ ì œì¶œ
            },
            body: formData,
          });

          const data = await res.json();
          if (data.status === "success") {
            currentAnalysisText = data.analysis;
            document.getElementById("result-area").innerHTML = marked.parse(
              data.analysis
            );
            document.getElementById("result-area").style.display = "block";
            document.getElementById("downloadTxtBtn").style.display = "block";
            document.getElementById("downloadPdfBtn").style.display = "block";

            setTimeout(() => loadHistory(), 500); // ì´ë ¥ ê°±ì‹ 
          } else {
            alert("ë¶„ì„ ì‹¤íŒ¨: " + (data.message || data.detail));
          }
        } catch (error) {
          console.error(error);
          alert("ì˜¤ë¥˜ ë°œìƒ");
        } finally {
          document.getElementById("loading").style.display = "none";
        }
      }

      // [ê¸°ëŠ¥ 5] ì´ë ¥ ë¶ˆëŸ¬ì˜¤ê¸° (í† í° ì²¨ë¶€!)
      async function loadHistory() {
        const token = localStorage.getItem("access_token");
        if (!token) return;

        try {
          const res = await fetch("http://127.0.0.1:8000/history", {
            headers: { Authorization: "Bearer " + token }, // â˜… ì¶œì…ì¦ ì œì¶œ
          });

          if (!res.ok) return; // í† í° ë§Œë£Œ ë“±

          const historyData = await res.json();
          const tableBody = document.getElementById("history-list");
          tableBody.innerHTML = "";

          historyData.forEach((item) => {
            const row = document.createElement("tr");
            let badgeClass = "badge-unknown";
            let riskText = item.risk_level || "ë¶„ì„ì™„ë£Œ";
            if (riskText.includes("ì•ˆì „")) badgeClass = "badge-safe";
            else if (riskText.includes("ì£¼ì˜")) badgeClass = "badge-warning";
            else if (riskText.includes("ìœ„í—˜")) badgeClass = "badge-danger";

            row.innerHTML = `<td>${item.created_at}</td><td>${item.filename}</td><td><span class="badge ${badgeClass}">${riskText}</span></td>`;
            row.onclick = () => viewHistoryDetail(item.analysis_result);
            tableBody.appendChild(row);
          });
        } catch (e) {
          console.error(e);
        }
      }

      // ìƒì„¸ ë³´ê¸° ë° ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤.
      function viewHistoryDetail(text) {
        currentAnalysisText = text;
        const area = document.getElementById("result-area");
        area.innerHTML = marked.parse(text);
        area.style.display = "block";
        document.getElementById("downloadTxtBtn").style.display = "block";
        document.getElementById("downloadPdfBtn").style.display = "block";
        window.scrollTo({ top: 100, behavior: "smooth" });
      }

      function downloadTxt() {
        /* ê¸°ì¡´ ì½”ë“œ ìœ ì§€ (ìƒëµ ê°€ëŠ¥) */
        if (!currentAnalysisText) return;
        const blob = new Blob([currentAnalysisText], { type: "text/plain" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "result.txt";
        link.click();
      }

      async function downloadPdf() {
        /* ê¸°ì¡´ ì½”ë“œ ìœ ì§€ */
        if (!currentAnalysisText) return;
        const btn = document.getElementById("downloadPdfBtn");
        btn.innerText = "ìƒì„± ì¤‘...";
        try {
          const res = await fetch("http://127.0.0.1:8000/create-pdf", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: currentAnalysisText }),
          });
          if (res.ok) {
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "report.pdf";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          }
        } catch (e) {
          alert("PDF ì˜¤ë¥˜");
        } finally {
          btn.innerText = "ğŸ“• PDF ì €ì¥";
        }
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
      window.onload = () => {
        if (localStorage.getItem("access_token")) {
          showApp();
        }
      };
    </script>
  </body>
</html>
